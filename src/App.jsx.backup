import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { DemoLanding } from './ClinicLanding';
import AdminLogin from './components/AdminLogin';
import AdminPanel from './components/AdminPanel';
import TestLoginOnly from './TestLoginOnly';

function App() {
  // FORCE authentication to FALSE - this should NEVER change on load
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  useEffect(() => {
    // Clear any stored authentication state and force false
    localStorage.clear();
    sessionStorage.clear();
    setIsAuthenticated(false); // Force it again
    console.log('ğŸ” App mounted - FORCING isAuthenticated to false');
    console.log('ğŸ” Environment VITE_API_URL:', import.meta.env.VITE_API_URL);
    console.log('ğŸ” All environment variables:', import.meta.env);
    console.log('ğŸ” App version timestamp:', Date.now()); // Force cache bust
  }, []);

  const handleLogin = (success) => {
    console.log('ğŸ”‘ Login attempt, success:', success);
    if (success) {
      console.log('âœ… Setting authentication to TRUE');
      setIsAuthenticated(true);
    }
  };

  const handleLogout = () => {
    console.log('ğŸšª Logout - Setting authentication to FALSE');
    setIsAuthenticated(false);
    localStorage.clear();
    sessionStorage.clear();
  };

  // Debug logging - this will show on EVERY render
  console.log('ğŸ” CURRENT RENDER - isAuthenticated:', isAuthenticated);
  console.log('ğŸ” CURRENT RENDER - window.location.pathname:', window.location.pathname);

  return (
    <Router>
      <Routes>
        <Route path="/" element={<DemoLanding />} />
        
        {/* TEST ROUTE - Should ONLY show login form */}
        <Route path="/test-login" element={<TestLoginOnly />} />
        
        <Route 
          path="/admin" 
          element={
            (() => {
              console.log('ğŸ” /admin route - isAuthenticated:', isAuthenticated);
              console.log('ğŸ” /admin route - typeof isAuthenticated:', typeof isAuthenticated);
              console.log('ğŸ” /admin route - isAuthenticated === false:', isAuthenticated === false);
              console.log('ğŸ” /admin route - !isAuthenticated:', !isAuthenticated);
              
              if (isAuthenticated === false) {
                console.log('â¡ï¸ FORCED: Showing AdminLogin component');
                return <AdminLogin onLogin={handleLogin} />;
              } else {
                console.log('â¡ï¸ FORCED: Redirecting to /admin/dashboard');
                return <Navigate to="/admin/dashboard" replace />;
              }
            })()
          } 
        />
        
        <Route 
          path="/admin/dashboard" 
          element={
            (() => {
              console.log('ğŸ” /admin/dashboard route - isAuthenticated:', isAuthenticated);
              if (isAuthenticated) {
                console.log('â¡ï¸ Showing AdminPanel component');
                return <AdminPanel onLogout={handleLogout} />;
              } else {
                console.log('â¡ï¸ Redirecting to /admin');
                return <Navigate to="/admin" replace />;
              }
            })()
          } 
        />
        
        <Route path="*" element={<Navigate to="/" replace />} />
      </Routes>
    </Router>
  );
}

export default App;